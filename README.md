# Cache
| Лабораторная работа №4    |   P31<13>   | Архитектура ЭВМ |
| ------------------------- | ----------- | --------------- |
| Кэш и кодирование команд  | Сущева Мария Егоровна  | 2024 |



Полученные параметры системы

| Параметр         | Значение (с единицами измерения) |
| ---------------- | --- |
| MEM_SIZE         | 512 Кбайт |
| ADDR_LEN         |  19 бит|
| CACHE_WAY        | 4  |
| CACHE_TAG_LEN    | 10 бит |
| CACHE_INDEX_LEN  | 4  бит|
| CACHE_OFFSET_LEN | 5 бит |
| CACHE_SIZE       | 2 Кбайт|
| CACHE_LINE_SIZE  | 32 байта |
| CACHE_LINE_COUNT | 64 |
| CACHE_SETS       | 16 |

# Расчёт:
ADDR_LEN = длина адреса, чтобы обратиться к одной ячейке(байту) = (Log2(MEM_SIZE(в байтах) = log2(2^19 байт)

CACHE_SETS = количество сетов в кэше, их номер для кэшлинии определяется CASH_INDEX, то есть всего 2^CASH_INDEXLEN сетов = 16

CACHE_WAY = сколько линий в сете -- кол-во линий/ кол-во сетов

CACHE_TAG_LEN = ADDR_LEN - CACHE_INDEX_LEN - CACHE_OFFSET_LEN (уникальный идентификатор кэш-линии)

CACHE_LINE_SIZE = 2^CACHE_OFFSET_LEN -- к скольким различным байтам благодаря оффсету можно получить доступ

CACHE_LINE_COUNT = CACHE_SIZE / CACHE_LINE_COUNT

# Структура кэша: 

Кэш реализован с помощью трёхмерного массива cacheLRU[set][way][wordIndex], где:
set – индекс сета (0 до 15), определяется по адресу через (address / 32) % 16;      
way – номер линии внутри сета (0 до 3), определяет ассоциативность;     
wordIndex – индекс 4-байтового слова внутри кэш-линии (0 до 7), так как 8 слов по 4 байта дают 32 байта на линию.

# Кэш-линия:
Каждая кэш-линия таким образом хранит: 8 целочисленных элементов по 4 байта, всего 32 байта. В свою очередь в программе хранение ячеек в памяти организовано так же(по 4 байта, адреса-- кратны 4)

Кроме массива с данными, для каждой кэш-линии хранится служебная информация в отдельных массивах:
tagLRU[set][way] – хранит тег для кэш-линии, позволяющий однозначно определить, соответствует ли данная линия нужному адресу. Изначально заполнен -1 -- показывающий невалидное состояние(линия пуста)

priorityLRU[set][way] – хранит приоритет для алгоритма вытеснения (LRU).Чем выше приоритет, тем более недавно использовалась линия.При замене выбирается линия с наименьшим приоритетом.

bitpLRU[set][way] --  хранит 1 и 0 для алгоритма вытеснения pLRU. Единица -- недавно использовалась, когда все ее достигают, у всех обнуляется, кроме текущей. При замене первая линия с нулем выбрасывается.

# Update
Но нужная  — write-back  — при вытеснении кэш-линия записывается в память, только если она отличается от своей копии в памяти(то есть если она была изменена). В код был добавлен массив usage[16][4], в котором для соответствующей кэш-линии ставится 1, если кэш-линия изменялась. Когда значение для кэш-линии берется из памяти, значение в этом массиве устанавливается 0. Таким образом, при вытеснении кэш-линии, мы смотрим, стоит ли 1 в массиве usage по ее индексу и сету  — переписываем в память. 


# Задание
Нужно было получить: 18/19 по попаданиям команд, 3/8 по попаданиям данных. При этом должно быть хотя бы одно вытеснении кэш-линии, команды lui, fence, addi, какая-то из branch инструкций.

lui ra, 3
sb zero, 1024, a0
addi a5, zero, 9
addi a6, a6, 1
bne a5, a6, -4
sb a0, 2067, a0
addi a1, zero, 4
sb a1, 5000, a0
addi a0, a0, 1
sb a5, 0, a0
bne a1, a0, -8
sb zero, 8192, a0
fence io, rw

Приведенная программа состоит из инструкций загрузки в память sb, которые загружают значения rs2 в память по адресу rs1+offset. Тут реализуются как раз-таки политики вытеснения, ведь offset подобран так, чтобы tag кэш-линии менялся, а индекс нет. Tаким образом, на пятый раз обращения произойдет вытеснение кэш-линии. Два цикла, организованные bne переброской указателя назад, когда значение одного регистра достигнет значение второго регистра, выступающего в роли счетчика(команды addi).Команды загружаются в память по 8 штук, у меня здесь 13 строк -- как минимум 2 мисса по командам, нужно всего исполнить команды 34 раза. В первом цикле команда bne перебрасывает на одну строчку назад, исполняется 9 раз, всего 18 исполнений команд из этого. Во втором цикле команда bne перебрасывает на две строчки назад, исполняется 4 раза, всего 12 исполнений команд из этого. Остальные команды добивают еще 6 исполнений. Если смотреть по данным,





